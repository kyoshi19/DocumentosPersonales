Module 6: Optimizer Statistics

Lab 6-1: Working with Optimizer Statistics - Solution
Lab Setup
There is a setup required for this lab. If you need to start this lab again at any time, the tables used in this lab can be refreshed by executing the batch script opt_setup.sh located in your $SYBASE/ptquery15 directory.

Objectives
After completing this lab, you should be able to:
* Understand when Adaptive Server creates, modifies, and removes optimizer statistics from system tables. 
* Troubleshoot poorly optimized queries. 

Description
In this lab, you will learn how to work with optimizer statistics.

Task Outline 
Task 1: Creating and Deleting Optimizer Statistics 
Task 2: Troubleshooting Poorly Optimized Point Queries (Case Study)



Detailed Instructions and Solutions
Task 1: Creating and Deleting Optimizer Statistics
Description
In this task, you will create and delete optimizer statistics.

Procedure

The solutions for this lab will be shown using isql instead of Interactive SQL. While Interactive SQL provides better formatted output, isql provides more comprehensive diagnostic output.

For all labs, you should open two windows (“A” and “B”). Unless instructed otherwise, perform all lab exercises in Window A. 
Use Window B primarily as a console for starting up Adaptive Server. All Adaptive Server system messages are displayed there instead of in your active window. Additionally, Window B saves you from having to change directories whenever the server needs to be restarted. 
1. Examine the characteristics of a table that has no indexes.
a. Be sure you are in the $SYBASE/ptquery15 directory and run the script opt_setup.sh

opt_setup.sh


Creating tables for OPTIMIZER STATISTICS lab exercises . . .
Creating 1st set of tables for OPTIMZER STATISTICS lab exercises . .
Starting copy...
1000 rows sent to SQL Server.
2000 rows sent to SQL Server.
3000 rows sent to SQL Server.
4000 rows sent to SQL Server.
5000 rows sent to SQL Server.
5000 rows copied.

( output deleted )

Creating final set of tables for OPTIMZER STATISTICS lab exercises . . .
(0 rows affected)
(1 row affected)
(5000 rows affected)
(1 row affected)


b. Log into Adaptive Server as the sa and access the pubtune_db database.

isql -Usa -P -Dpubtune_db

c. Determine whether the titles table has any indexes.

sp_helpindex titles

Object does not have any indexes.
(return status = 1)

Does the titles table have any indexes?
No.d. Verify that Adaptive Server is storing table statistics but not index statistics for the titles table by executing the following query:

select count(*) from systabstats where id = object_id("titles")

 -----------
           1
(1 row affected)


Every table has one row in systabstats for the table statistics. If there is more than one row for the table, then there are also index statistics.
Does the titles table have any indexes?
No. There is only one row in systabstats for this table.
e. In Window B (at the operating system prompt), verify that Adaptive Server is not storing any index or column statistics for the table by using the optdiag utility as follows:

optdiag statistics pubtune_db..titles -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "titles"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "titles"

Statistics for table:                   "titles"

     Data page count:                   624
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                0.0000000000000000
     OAM + allocation page count:       6
     First extent data pages:           0
     Data row size:                     184.0000000000000000
     Parallel join degree:              0.0000000000000000
     Unused page count:                 5
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           0.9999900000000001
     Space utilization:                 0.7313288563288564
     Large I/O efficiency:              1.0000000000000000

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "price"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"
                                        "type"

Optdiag succeeded.


Can you determine from the optdiag output whether the table has any indexes?
The optdiag output displays table statistics such as Data Page Count, but there are no column or index statistics displayed. If the table had any indexes, optdiag would, at a minimum, display index statistics.
The table has no indexes.2. Using Window A, turn off the histogram tuning factor and create some indexes on the titles table.
a. Turn off the histogram tuning factor

sp_configure “histogram tuning factor”, 1

b. Create a clustered index on the price column.

create clustered index idx1 on titles(price)

c. Create a composite (multi-column) nonclustered index on the type and pub_id columns.

create index idx2 on titles(type, pub_id)

3. In Window B (at the operating system prompt), verify that Adaptive Server now stores index and column statistics for the table by using the optdiag utility again:

optdiag statistics pubtune_db..titles -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "titles"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "titles"

Statistics for index:                   "idx1" (clustered)
Index column list:                      "price"
     Data page count:                   650
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                82.0000000000000000
     OAM + allocation page count:       5
     First extent leaf pages:           0
     Data row size:                     232.7716000000000100
     Index height:                      1
     Parallel join degree:              0.0000000000000000
     Unused page count:                 13
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.8881700244200245
     Large I/O efficiency:              1.0000000000000000

Statistics for index:                   "idx2" (nonclustered)
Index column list:                      "type", "pub_id"
     Leaf count:                        71
     Empty leaf page count:             0
     Data page CR count:                4477.0000000000000000
     Index page CR count:               10.0000000000000000
     Data row CR count:                 4673.0000000000000000
     First extent leaf pages:           0
     Leaf row size:                     28.0000000000000000
     Index height:                      2

  Derived statistics:                   
     Data page cluster ratio:           0.0426922239163581
     Index page cluster ratio:          0.9838709677419355
     Data row cluster ratio:            0.0751724137931035
     Space utilization:                 0.9780907668231612
     Large I/O efficiency:              1.0000000000000000

Statistics for column:                  "price"
Last update of column statistics:       Feb 22 2009  1:06:47:106PM

     Range cell density:                0.0134830400000000
     Total density:                     0.0134830400000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0133333333333333
     Unique total values:               0.0133333333333333
     Average column width:              8.0000000000000000

Histogram for column:                   "price"
Column datatype:                        money
Requested step count:                   20
Actual step count:                      20
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000       <=       1.95
        2     0.06220000       <=       5.95
        3     0.05360000       <=       9.95
        4     0.06420000       <=       14.95
        5     0.05300000       <=       18.95
        6     0.06340000       <=       24.95
        7     0.05400000       <=       28.95
        8     0.05660000       <=       32.95
        9     0.05600000       <=       36.95
       10     0.05480000       <=       41.95
       11     0.05180000       <=       45.95
       12     0.05380000       <=       49.95
       13     0.05660000       <=       53.95
       14     0.04860000       <=       57.95
       15     0.05240000       <=       62.95
       16     0.05620000       <=       66.95
       17     0.05440000       <=       70.95
       18     0.03760000       <=       73.95
       19     0.04320000       <=       201.95
       20     0.02760000       <=       1010.00

Statistics for column:                  "type"
Last update of column statistics:       Feb 22 2009  1:07:00:106PM

     Range cell density:                0.0000000000000000
     Total density:                     0.1111865600000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.1111111111111111
     Average column width:              default used (12.00)

Histogram for column:                   "type"
Column datatype:                        char(12)
Requested step count:                   20
Actual step count:                      18
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       "UNDECIDED   "
        2     0.11500000        =       "UNDECIDED   "
        3     0.00000000        <       "adventure   "
        4     0.11000000        =       "adventure   "
        5     0.00000000        <       "business    "
        6     0.11040000        =       "business    "
        7     0.00000000        <       "computer    "
        8     0.11640000        =       "computer    "
        9     0.00000000        <       "cooking     "
       10     0.11080000        =       "cooking     "
       11     0.00000000        <       "news        "
       12     0.10660000        =       "news        "
       13     0.00000000        <       "psychology  "
       14     0.11180000        =       "psychology  "
       15     0.00000000        <       "romance     "
       16     0.10800000        =       "romance     "
       17     0.00000000        <       "travel      "
       18     0.11100000        =       "travel      "

Statistics for column group:            "type", "pub_id"
Last update of column statistics:       Feb 22 2009  1:07:00:106PM

     Range cell density:                0.0000000000000000
     Total density:                     0.0039048000000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.0037037037037037
     Average column width:              4.0000000000000000

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"

Optdiag succeeded.


Can you determine from the optdiag output whether the table has any indexes?
The optdiag output is now much lengthier than before and clearly shows statistics for each of the two indexes as well as the column statistics (histograms).4. Create column statistics for a nonindexed column in the titles table.
a. Create column statistics (but not an index) for the advance column by using the update statistics command.

update statistics titles(advance)

b. Window B: Verify that Adaptive Server now stores column statistics (but not index statistics) for the advance column by using optdiag.

optdiag statistics pubtune_db..titles -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "titles"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "titles"

Statistics for index:                   "idx1" (clustered)
Index column list:                      "price"
     Data page count:                   650
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                82.0000000000000000
     OAM + allocation page count:       5
     First extent leaf pages:           0
     Data row size:                     232.7716000000000100
     Index height:                      1
     Parallel join degree:              0.0000000000000000
     Unused page count:                 13
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.8881700244200245
     Large I/O efficiency:              1.0000000000000000

Statistics for index:                   "idx2" (nonclustered)
Index column list:                      "type", "pub_id"
     Leaf count:                        71
     Empty leaf page count:             0
     Data page CR count:                4477.0000000000000000
     Index page CR count:               10.0000000000000000
     Data row CR count:                 4673.0000000000000000
     First extent leaf pages:           0
     Leaf row size:                     28.0000000000000000
     Index height:                      2

  Derived statistics:                   
     Data page cluster ratio:           0.0426922239163581
     Index page cluster ratio:          0.9838709677419355
     Data row cluster ratio:            0.0751724137931035
     Space utilization:                 0.9780907668231612
     Large I/O efficiency:              1.0000000000000000

Statistics for column:                  "advance"
Last update of column statistics:       Feb 22 2009  1:12:38:153PM

     Range cell density:                0.0000000000000000
     Total density:                     0.1806151200000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.1000000000000000
     Average column width:              8.0000000000000000

Histogram for column:                   "advance"
Column datatype:                        money
Requested step count:                   20
Actual step count:                      20
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       0.00
        2     0.36899999        =       0.00
        3     0.00000000        <       1000.00
        4     0.07100000        =       1000.00
        5     0.00000000        <       2000.00
        6     0.06580000        =       2000.00
        7     0.00000000        <       3000.00
        8     0.06400000        =       3000.00
        9     0.00000000        <       4000.00
       10     0.06900000        =       4000.00
       11     0.00000000        <       5000.00
       12     0.07000000        =       5000.00
       13     0.00000000        <       7500.00
       14     0.07080000        =       7500.00
       15     0.00000000        <       10000.00
       16     0.06580000        =       10000.00
       17     0.00000000        <       15000.00
       18     0.08140000        =       15000.00
       19     0.00000000        <       20000.00
       20     0.07320000        =       20000.00

Statistics for column:                  "price"
Last update of column statistics:       Feb 22 2009  1:06:47:106PM

     Range cell density:                0.0134830400000000
     Total density:                     0.0134830400000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0133333333333333
     Unique total values:               0.0133333333333333
     Average column width:              8.0000000000000000

Histogram for column:                   "price"
Column datatype:                        money
Requested step count:                   20
Actual step count:                      20
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000       <=       1.95
        2     0.06220000       <=       5.95
        3     0.05360000       <=       9.95
        4     0.06420000       <=       14.95
        5     0.05300000       <=       18.95
        6     0.06340000       <=       24.95
        7     0.05400000       <=       28.95
        8     0.05660000       <=       32.95
        9     0.05600000       <=       36.95
       10     0.05480000       <=       41.95
       11     0.05180000       <=       45.95
       12     0.05380000       <=       49.95
       13     0.05660000       <=       53.95
       14     0.04860000       <=       57.95
       15     0.05240000       <=       62.95
       16     0.05620000       <=       66.95
       17     0.05440000       <=       70.95
       18     0.03760000       <=       73.95
       19     0.04320000       <=       201.95
       20     0.02760000       <=       1010.00

Statistics for column:                  "type"
Last update of column statistics:       Feb 22 2009  1:07:00:106PM

     Range cell density:                0.0000000000000000
     Total density:                     0.1111865600000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.1111111111111111
     Average column width:              default used (12.00)

Histogram for column:                   "type"
Column datatype:                        char(12)
Requested step count:                   20
Actual step count:                      18
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       "UNDECIDED   "
        2     0.11500000        =       "UNDECIDED   "
        3     0.00000000        <       "adventure   "
        4     0.11000000        =       "adventure   "
        5     0.00000000        <       "business    "
        6     0.11040000        =       "business    "
        7     0.00000000        <       "computer    "
        8     0.11640000        =       "computer    "
        9     0.00000000        <       "cooking     "
       10     0.11080000        =       "cooking     "
       11     0.00000000        <       "news        "
       12     0.10660000        =       "news        "
       13     0.00000000        <       "psychology  "
       14     0.11180000        =       "psychology  "
       15     0.00000000        <       "romance     "
       16     0.10800000        =       "romance     "
       17     0.00000000        <       "travel      "
       18     0.11100000        =       "travel      "

Statistics for column group:            "type", "pub_id"
Last update of column statistics:       Feb 22 2009  1:07:00:106PM

     Range cell density:                0.0000000000000000
     Total density:                     0.0039048000000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.0037037037037037
     Average column width:              4.0000000000000000

No statistics for remaining columns:    "contract"
(default values used)                   "notes"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"

Optdiag succeeded.

Are there column and index statistics for the advance column? Explain.
There are column statistics, but no index statistics, for the advance column. This column is not indexed.
5. Examine what happens to index and column statistics when indexes are dropped.
a. Drop the two indexes that you just created for the titles table.

drop index titles.idx1
drop index titles.idx2

b. Window B: Determine whether Adaptive Server still stores column and index statistics for the dropped indexes by using optdiag.

optdiag statistics pubtune_db..titles -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "titles"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "titles"

Statistics for table:                   "titles"

     Data page count:                   650
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                82.0000000000000000
     OAM + allocation page count:       5
     First extent data pages:           0
     Data row size:                     232.7716000000000100
     Parallel join degree:              0.0000000000000000
     Unused page count:                 13
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.8881700244200245
     Large I/O efficiency:              1.0000000000000000

Statistics for column:                  "advance"
Last update of column statistics:       Feb 22 2009  1:12:38:153PM

     Range cell density:                0.0000000000000000
     Total density:                     0.1806151200000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.1000000000000000
     Average column width:              8.0000000000000000

Histogram for column:                   "advance"
Column datatype:                        money
Requested step count:                   20
Actual step count:                      20
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       0.00
        2     0.36899999        =       0.00
        3     0.00000000        <       1000.00
        4     0.07100000        =       1000.00
        5     0.00000000        <       2000.00
        6     0.06580000        =       2000.00
        7     0.00000000        <       3000.00
        8     0.06400000        =       3000.00
        9     0.00000000        <       4000.00
       10     0.06900000        =       4000.00
       11     0.00000000        <       5000.00
       12     0.07000000        =       5000.00
       13     0.00000000        <       7500.00
       14     0.07080000        =       7500.00
       15     0.00000000        <       10000.00
       16     0.06580000        =       10000.00
       17     0.00000000        <       15000.00
       18     0.08140000        =       15000.00
       19     0.00000000        <       20000.00
       20     0.07320000        =       20000.00

Statistics for column:                  "price"
Last update of column statistics:       Feb 22 2009  1:06:47:106PM

     Range cell density:                0.0134830400000000
     Total density:                     0.0134830400000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0133333333333333
     Unique total values:               0.0133333333333333
     Average column width:              8.0000000000000000

Histogram for column:                   "price"
Column datatype:                        money
Requested step count:                   20
Actual step count:                      20
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000       <=       1.95
        2     0.06220000       <=       5.95
        3     0.05360000       <=       9.95
        4     0.06420000       <=       14.95
        5     0.05300000       <=       18.95
        6     0.06340000       <=       24.95
        7     0.05400000       <=       28.95
        8     0.05660000       <=       32.95
        9     0.05600000       <=       36.95
       10     0.05480000       <=       41.95
       11     0.05180000       <=       45.95
       12     0.05380000       <=       49.95
       13     0.05660000       <=       53.95
       14     0.04860000       <=       57.95
       15     0.05240000       <=       62.95
       16     0.05620000       <=       66.95
       17     0.05440000       <=       70.95
       18     0.03760000       <=       73.95
       19     0.04320000       <=       201.95
       20     0.02760000       <=       1010.00

Statistics for column:                  "type"
Last update of column statistics:       Feb 22 2009  1:07:00:106PM

     Range cell density:                0.0000000000000000
     Total density:                     0.1111865600000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.1111111111111111
     Average column width:              default used (12.00)

Histogram for column:                   "type"
Column datatype:                        char(12)
Requested step count:                   20
Actual step count:                      18
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       "UNDECIDED   "
        2     0.11500000        =       "UNDECIDED   "
        3     0.00000000        <       "adventure   "
        4     0.11000000        =       "adventure   "
        5     0.00000000        <       "business    "
        6     0.11040000        =       "business    "
        7     0.00000000        <       "computer    "
        8     0.11640000        =       "computer    "
        9     0.00000000        <       "cooking     "
       10     0.11080000        =       "cooking     "
       11     0.00000000        <       "news        "
       12     0.10660000        =       "news        "
       13     0.00000000        <       "psychology  "
       14     0.11180000        =       "psychology  "
       15     0.00000000        <       "romance     "
       16     0.10800000        =       "romance     "
       17     0.00000000        <       "travel      "
       18     0.11100000        =       "travel      "

Statistics for column group:            "type", "pub_id"
Last update of column statistics:       Feb 22 2009  1:07:00:106PM

     Range cell density:                0.0000000000000000
     Total density:                     0.0039048000000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0000000000000000
     Unique total values:               0.0037037037037037
     Average column width:              4.0000000000000000

No statistics for remaining columns:    "contract"
(default values used)                   "notes"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"

Optdiag succeeded.
                         

Does Adaptive Server still store index and column statistics for the dropped indexes?
Adaptive Server has clearly removed the index statistics but still stores the column statistics and histograms.
Has there been any change to the information reported on the advance column?
No. Just as before, Adaptive Server stores the column statistics and histogram for the nonindexed column but does not store index statistics.
6. Drop all column statistics for the titles table.
a. Drop all column statistics for the titles table by using the delete statistics command.

delete statistics titles

b. Window B: Verify that Adaptive Server no longer stores index and column statistics for the titles table. 

optdiag statistics pubtune_db..titles -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "titles"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "titles"

Statistics for table:                   "titles"

     Data page count:                   650
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                82.0000000000000000
     OAM + allocation page count:       5
     First extent data pages:           0
     Data row size:                     232.7716000000000100
     Parallel join degree:              0.0000000000000000
     Unused page count:                 13
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.8881700244200245
     Large I/O efficiency:              1.0000000000000000

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "price"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"
                                        "type"

Optdiag succeeded.


Have all index and column statistics for the titles table been removed?
Yes, but notice that Adaptive Server still stores table-level statistics.

7. Examine a table that has an index but no column statistics.
a. Create a nonclustered index on the price column of the titles table.

create index idx1 on titles(price)

b. Drop all column statistics for the titles table by using the delete statistics command.

delete statistics titles

c. Window B: Verify that Adaptive Server still stores index statistics but no longer stores column statistics for the titles table by using optdiag.

optdiag statistics pubtune_db..titles -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "titles"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "titles"

Statistics for table:                   "titles"

     Data page count:                   650
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                82.0000000000000000
     OAM + allocation page count:       5
     First extent data pages:           0
     Data row size:                     232.7716000000000100
     Parallel join degree:              0.0000000000000000
     Unused page count:                 13
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.8881700244200245
     Large I/O efficiency:              1.0000000000000000

Statistics for index:                   "idx1" (nonclustered)
Index column list:                      "price"
     Leaf count:                        50
     Empty leaf page count:             0
     Data page CR count:                135.0000000000000000
     Index page CR count:               7.0000000000000000
     Data row CR count:                 650.0000000000000000
     First extent leaf pages:           0
     Leaf row size:                     20.0000000000000000
     Index height:                      1

  Derived statistics:                   
     Data page cluster ratio:           0.9066901408450704
     Index page cluster ratio:          1.0000000000000000
     Data row cluster ratio:            1.0000000000000000
     Space utilization:                 0.9920634920634921
     Large I/O efficiency:              1.0000000000000000

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "price"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"
                                        "type"

Optdiag succeeded.
d. Verify that the titles table still has indexes.

sp_helpindex titles


Object has the following indexes
 


index_name index_keys index_description index_max_rows_per_page index_fillfactor index_reservepagegap index_created       index_local  
---------- ---------- ----------------- ----------------------- ---------------- -------------------- ------------------- ------------ 
idx1        price     nonclustered                            0                0                    0 Feb 22 2009 1:18PM Global Index 


index_ptn_name  index_ptn_seg 
--------------- ------------- 
idx1_1820530488 default



What are the ramifications of having an index without supporting column statistics?
Adaptive Server may not use the index for queries that may benefit greatly from it.
How could you recreate the column and index column statistics for an existing index?
Use the update statistics command for each indexed column, for example:
update statistics titles(price)
Alternatively, you can drop the index altogether and recreate the index.e. Drop the index on the titles table.

drop index titles.idx1

Task 2: Troubleshooting Poorly Optimized Point Queries (Case Study)
Description
In this task, you will troubleshoot poorly optimized point queries.

Procedure
1. Examining the characteristics of a table with a nonclustered index.
a. Verify that the table named opt_tab1 has a nonclustered index on the type column.

sp_helpindex opt_tab1

Object has the following indexes

index_name index_keys index_description index_max_rows_per_page index_fillfactor index_reservepagegap index_created       index_local  
---------- ---------- ----------------- ----------------------- ---------------- -------------------- ------------------- ------------ 
idx1        type      nonclustered                            0                0                    0 Feb 22 2009 1:18PM Global Index 


index_ptn_name  index_ptn_seg 
--------------- ------------- 
idx1_2044531286 default        
b. Determine how many rows the table has.

select count(*) from opt_tab1

 -----------
        5000

(1 row affected)

c. Determine how many rows have type = “computer” and write down the result.

select count(*) from opt_tab1 where type = "computer"
 
 -----------
         100

(1 row affected)
2.	Determine whether Adaptive Server uses the index on the type column.
a. Activate the Adaptive Server diagnostics commands showplan and noexec.

set showplan, noexec on
b. Issue the following query that uses type as a search argument (SARG).

select * from opt_tab1 where type = "computer"

QUERY PLAN FOR STATEMENT 1 (at line 1).


    STEP 1
        The type of query is SELECT.

	1 operator(s) under root

       |ROOT:EMIT Operator (VA = 1)
       |
       |   |SCAN Operator (VA = 0)
       |   |  FROM TABLE
       |   |  opt_tab1
       |   |  Table Scan.
       |   |  Forward Scan.
       |   |  Positioning at start of table.
       |   |  Using I/O Size 2 Kbytes for data pages.
       |   |  With LRU Buffer Replacement Strategy for data pages.


What access method was used (table scan or index)? Explain. 
A table scan was used.
Would it seem reasonable that Adaptive Server could have used the index? Explain. 
Using an index seems like a reasonable approach because the table has 5000 rows and only 100 have type = “computer”.
3.	Analyze the cause of the poorly optimized query.
a. In Window B, use the optdiag utility to examine the index and column statistics for the opt_tab1 table.

optdiag statistics pubtune_db..opt_tab1 -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "opt_tab1"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "opt_tab1"

Statistics for table:                   "opt_tab1"

     Data page count:                   623
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                78.0000000000000000
     OAM + allocation page count:       6
     First extent data pages:           0
     Data row size:                     184.0000000000000000
     Parallel join degree:              0.0000000000000000
     Unused page count:                 5
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.7325027389232847
     Large I/O efficiency:              1.0000000000000000

Statistics for index:                   "idx1" (nonclustered)
Index column list:                      "type"
     Leaf count:                        48
     Empty leaf page count:             0
     Data page CR count:                2953.0000000000000000
     Index page CR count:               7.0000000000000000
     Data row CR count:                 3526.0000000000000000
     First extent leaf pages:           0
     Leaf row size:                     19.0000000000000000
     Index height:                      1

  Derived statistics:                   
     Data page cluster ratio:           0.1661832946635731
     Index page cluster ratio:          0.9761904761904762
     Data row cluster ratio:            0.3367603381311400
     Space utilization:                 0.9817294973544973
     Large I/O efficiency:              1.0000000000000000

Statistics for column:                  "type"
Last update of column statistics:       Aug 11 1998 12:00:00:000AM
Statistics loaded from Optdiag.

     Range cell density:                0.0200000000000000
     Total density:                     0.1073305600000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               default used (0.020000)
     Unique total values:               default used (0.107331)
     Average column width:              default used (12.00)

Histogram for column:                   "type"
Column datatype:                        char(12)
Requested step count:                   20
Actual step count:                      19
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       "UNDECIDED   "
        2     0.01500000        =       "UNDECIDED   "
        3     0.00000000        <       "adventure   "
        4     0.05000000        =       "adventure   "
        5     0.01040000       <=       "business    "
        6     0.00000000        <       "computer    "
        7     0.81639999        =       "computer    "
        8     0.00000000        <       "cooking     "
        9     0.01080000        =       "cooking     "
       10     0.00000000        <       "news        "
       11     0.02060000        =       "news        "
       12     0.00000000        <       "psychology  "
       13     0.02180000        =       "psychology  "
       14     0.00000000        <       "romance     "
       15     0.01800000        =       "romance     "
       16     0.00000000        <       "software    "
       17     0.02600000        =       "software    "
       18     0.00000000        <       "travel      "
       19     0.01100000        =       "travel      "

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "price"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"

Optdiag succeeded.


Are there index and column statistics for the type column? 
Yes, there are both index and column statistics for the column.
Is there any information in the optdiag output that leads you to think that the statistics are not up-to-date?
There are at least two pieces of information that stand out:
1. The last update of column statistics occurred August 11, 1998.
2. The histogram for the type column has a step for the value “= computer”, but the weight indicates that over 80% of the rows qualify.
 7     0.81639999        =       "computer    "
Apparently, the table used to store primarily “computer”-type books, but those statistics appear to be out-of-date now due to insert/update/ delete activity on the table.
b. Based on the histogram for the type column in the optdiag output, calculate how many rows Adaptive Server expects to have type = “computer”?
0.81639999 (weight)  * 5000 (rows in the table) = 4081
c. Did the optimizer choose the “optimal” access method based on the statistics? Explain.
Yes. Based on the information available to the optimizer, the optimizer used a table scan because the statistics indicate that over 4000 rows (over 80% of the table) would be accessed and the data is not physically stored in sorted order on the key column. Even though you know that the table contains only 100 qualifying rows (see step 1c), Adaptive Server “thinks” that using an index would have been inefficient.
4.	Take corrective action for this poorly optimized query.
a. Is it necessary to drop and re-create the index or can you just regenerate the statistics? Explain.
Dropping and re-creating the index would certainly generate up-to-date statistics, but it would also rebuild the index structure. If time does not permit this approach (in production), then regenerating the statistics would be sufficient for now.
b. In Window A: Turn off the Adaptive Server diagnostics commands showplan and noexec.

set showplan, noexec off

QUERY PLAN FOR STATEMENT 1 (at line 1).

    STEP 1
        The type of query is SET OPTION OFF.

c. Drop the current column statistics for the type column in opt_tab1.

delete statistics opt_tab1(type)

d. In Window B (operating system prompt), use optdiag to verify that the column statistics for the type column have been removed.

optdiag statistics pubtune_db..opt_tab1 -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "opt_tab1"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "opt_tab1"

Statistics for table:                   "opt_tab1"

     Data page count:                   623
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                78.0000000000000000
     OAM + allocation page count:       6
     First extent data pages:           0
     Data row size:                     184.0000000000000000
     Parallel join degree:              0.0000000000000000
     Unused page count:                 5
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.7325027389232847
     Large I/O efficiency:              1.0000000000000000

Statistics for index:                   "idx1" (nonclustered)
Index column list:                      "type"
     Leaf count:                        48
     Empty leaf page count:             0
     Data page CR count:                2953.0000000000000000
     Index page CR count:               7.0000000000000000
     Data row CR count:                 3526.0000000000000000
     First extent leaf pages:           0
     Leaf row size:                     19.0000000000000000
     Index height:                      1

  Derived statistics:                   
     Data page cluster ratio:           0.1661832946635731
     Index page cluster ratio:          0.9761904761904762
     Data row cluster ratio:            0.3367603381311400
     Space utilization:                 0.9817294973544973
     Large I/O efficiency:              1.0000000000000000

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "price"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"
                                        "type"

Optdiag succeeded.


Are there index and column statistics for the type column? 
The delete statistics command removed the column statistics (histogram), but not the index statistics, for the type column.
e. Create a new histogram for the type column using the update statistics command.

update statistics opt_tab1(type)

5.	Verify that the column statistics have been updated and that the correct query plan is generated.
a. In Window B (operating system prompt), use optdiag to verify that the statistics for the type column have been updated.

optdiag statistics pubtune_db..opt_tab1 -Usa -P

(…header deleted…)

Server name:                            "CHI102_2K"

Specified database:                     "pubtune_db"
Specified table owner:                  not specified
Specified table:                        "opt_tab1"
Specified column:                       not specified

Table owner:                            "dbo"
Table name:                             "opt_tab1"

Statistics for table:                   "opt_tab1"

     Data page count:                   623
     Empty data page count:             0
     Data row count:                    5000.0000000000000000
     Forwarded row count:               0.0000000000000000
     Deleted row count:                 0.0000000000000000
     Data page CR count:                78.0000000000000000
     OAM + allocation page count:       6
     First extent data pages:           0
     Data row size:                     184.0000000000000000
     Parallel join degree:              0.0000000000000000
     Unused page count:                 5
     OAM page count:                    1

  Derived statistics:                   
     Data page cluster ratio:           1.0000000000000000
     Space utilization:                 0.7325027389232847
     Large I/O efficiency:              1.0000000000000000

Statistics for index:                   "idx1" (nonclustered)
Index column list:                      "type"
     Leaf count:                        48
     Empty leaf page count:             0
     Data page CR count:                2953.0000000000000000
     Index page CR count:               7.0000000000000000
     Data row CR count:                 3526.0000000000000000
     First extent leaf pages:           0
     Leaf row size:                     19.0000000000000000
     Index height:                      1

  Derived statistics:                   
     Data page cluster ratio:           0.1661832946635731
     Index page cluster ratio:          0.9761904761904762
     Data row cluster ratio:            0.3367603381311400
     Space utilization:                 0.9817294973544973
     Large I/O efficiency:              1.0000000000000000

Statistics for column:                  "type"
Last update of column statistics:       Feb 22 2009  1:26:27:153PM

     Range cell density:                0.0200000000000000
     Total density:                     0.1073305600000000
     Range selectivity:                 default used (0.33)
     In between selectivity:            default used (0.25)
     Unique range values:               0.0200000000000000
     Unique total values:               0.1000000000000000
     Average column width:              default used (12.00)

Histogram for column:                   "type"
Column datatype:                        char(12)
Requested step count:                   20
Actual step count:                      19
Sampling Percent:                       0
Out of range Histogram Adjustment is DEFAULT.

     Step     Weight                    Value

        1     0.00000000        <       "UNDECIDED   "
        2     0.11500000        =       "UNDECIDED   "
        3     0.00000000        <       "adventure   "
        4     0.11000000        =       "adventure   "
        5     0.00000000        <       "business    "
        6     0.11040000        =       "business    "
        7     0.02000000       <=       "computer    "
        8     0.00000000        <       "cooking     "
        9     0.11080000        =       "cooking     "
       10     0.00000000        <       "news        "
       11     0.10660000        =       "news        "
       12     0.00000000        <       "psychology  "
       13     0.11180000        =       "psychology  "
       14     0.00000000        <       "romance     "
       15     0.10800000        =       "romance     "
       16     0.00000000        <       "software    "
       17     0.09640000        =       "software    "
       18     0.00000000        <       "travel      "
       19     0.11100000        =       "travel      "

No statistics for remaining columns:    "advance"
(default values used)                   "contract"
                                        "notes"
                                        "price"
                                        "pub_id"
                                        "pubdate"
                                        "title"
                                        "title_id"
                                        "total_sales"

Optdiag succeeded.


Are the Last update of column statistics and the weight associated with the step = “computer” up-to-date? Explain
The time stamp reflects the current system time (in this example, Apr 12 2008). 
Calculate how many rows the optimizer will now expect to have type = “computer” based on the histogram weight. Compare your calculation to the result in step 1c.
The histogram indicates that approximately 2% of the table (0.02) will qualify:
0.02 * 5000 rows = 100 qualifying rows
See the solution for question 1c!
6. Determine whether Adaptive Server now uses the index on the type column.
a. In Window A, activate the Adaptive Server diagnostics commands showplan and noexec.

set showplan, noexec on

b. Issue the following query again that uses type as a search argument (SARG).

select * from opt_tab1 where type = "computer"


QUERY PLAN FOR STATEMENT 1 (at line 1).


    STEP 1
        The type of query is SELECT.

	1 operator(s) under root

       |ROOT:EMIT Operator (VA = 1)
       |
       |   |SCAN Operator (VA = 0)
       |   |  FROM TABLE
       |   |  opt_tab1
       |   |  Index : idx1
       |   |  Forward Scan.
       |   |  Positioning by key.
       |   |  Keys are:
       |   |    type ASC
       |   |  Using I/O Size 2 Kbytes for index leaf pages.
       |   |  With LRU Buffer Replacement Strategy for index leaf pages.
       |   |  Using I/O Size 2 Kbytes for data pages.
       |   |  With LRU Buffer Replacement Strategy for data pages.


Was the diagnosis of the problem accurate and did the corrective action cause Adaptive Server to generate the best query plan?
The showplan output indicates that the index is now being used for the query. Good job!c. In Window A, turn off the Adaptive Server diagnostic commands showplan and noexec.

set showplan, noexec off


QUERY PLAN FOR STATEMENT 1 (at line 1).


    STEP 1
        The type of query is SET OPTION OFF.



